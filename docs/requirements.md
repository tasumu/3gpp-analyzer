# 要件定義

## 1. プロジェクト概要

### 1.1 プロジェクト名

3GPP Analyzer（寄書分析エージェント）

### 1.2 目的

3GPP標準化寄書（ZIP / doc / docx / pdf）を自動解析し、要点・変更点・論点・比較結果を抽出・提示するシステム

### 1.3 背景・課題

- 3GPP標準化会合の寄書は大量かつ複雑
- 手動でのレビューは時間がかかる
- 関連文書間の比較・追跡が困難

### 1.4 スコープ

**対象範囲（In Scope）**

- 3GPP寄書の自動取得・正規化
- 文書構造の抽出・チャンク化
- LLMによる分析・要約
- 根拠付き分析結果の提示
- レビューシート生成

**対象外（Out of Scope）**

- 3GPP以外の標準化文書
- リアルタイム会合議事録
- 文書の編集・作成機能

### 1.5 データソース

**3GPP FTP サーバー**

| 項目 | 値 |
|------|-----|
| URL | `ftp://ftp.3gpp.org/` |
| 認証 | 匿名アクセス（anonymous） |
| 対象 | `tsg_sa/`, `tsg_ran/`, `tsg_ct/` 配下の会合フォルダ |

**初期スコープ: オンデマンド同期**

全会合のメタデータを事前同期すると膨大（数十万〜100万件）になるため、オンデマンド方式を採用。

| 処理 | タイミング |
|------|-----------|
| ディレクトリ構造取得 | 初回起動時（軽量） |
| 会合メタデータ同期 | ユーザーが会合を選択した時点 |
| ファイルダウンロード | 分析実行時 |

---

## 2. 機能要件

### 2.1 文書取得・正規化機能

| ID | 機能 | 詳細 | 優先度 |
|----|------|------|--------|
| FR-001 | FTP同期 | ディレクトリ構造とメタ情報のみ先行同期。ファイル本体は必要時のみダウンロード | 必須 |
| FR-002 | ZIP展開・キャッシュ | 更新検知時のみ再展開。キャッシュによる重複処理回避 | 必須 |
| FR-003 | ファイル正規化 | .doc → .docx（LibreOffice headless）。出力形式: docx / text / json | 必須 |

### 2.2 文書構造化機能

| ID | 機能 | 詳細 | 優先度 |
|----|------|------|--------|
| FR-010 | 構造抽出 | 見出し（条項）、段落、表、図キャプションの抽出 | 必須 |
| FR-011 | 条項単位チャンク化 | 条項境界での分割、適切なチャンクサイズ維持 | 必須 |
| FR-012 | メタデータ付与 | 寄書番号、会合情報、条項番号、ページ番号、元ファイル参照 | 必須 |

### 2.3 分析機能

| ID | 機能 | 詳細 | 優先度 |
|----|------|------|--------|
| FR-020 | 単体分析 | 単一寄書の要点抽出、変更点特定、論点整理 | 必須 |
| FR-021 | 比較分析 | 複数寄書の差分抽出、関連性分析 | 必須 |
| FR-022 | 根拠付き回答 | 全分析結果に引用元を付与。引用トレーサビリティの確保 | 必須 |
| FR-023 | 言語選択 | 分析結果の出力言語を選択可能（日本語/英語）。Evidenceは原文維持 | 必須 |
| FR-024 | カスタム分析 | ユーザー定義のプロンプトによる柔軟な分析（例: 特定観点でのサマリー、特定内容の有無確認） | 必須 |
| FR-025 | プロンプト保存 | カスタム分析用プロンプトの保存・再利用機能 | 必須 |

### 2.4 成果物生成機能

| ID | 機能 | 詳細 | 優先度 |
|----|------|------|--------|
| FR-030 | レビューシート生成 | Markdown形式、要点・変更点・論点の整理、根拠引用の明示 | 必須 |
| FR-031 | 成果物ダウンロード | 署名付きURLによる安全なダウンロード | 必須 |

### 2.5 ユーザーインターフェース

| ID | 機能 | 詳細 | 優先度 |
|----|------|------|--------|
| FR-040 | 分析実行UI | Webインターフェースからの分析実行 | 必須 |
| FR-041 | 結果表示UI | 分析結果の表示、根拠の確認 | 必須 |
| FR-042 | 文書管理UI | 会合単位での文書一覧表示、ダウンロード/処理の手動トリガー | 必須 |
| FR-043 | 処理状況表示 | 文書ごとの処理ステータス可視化（メタ同期済/DL中/展開中/正規化済/ベクトル化済） | 必須 |

---

## 3. 非機能要件

### 3.1 パフォーマンス

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-001 | 分析API応答開始 | 3秒以内 |
| NFR-002 | ストリーミング | 段階的結果表示（SSE） |

### 3.2 セキュリティ

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-020 | 認証 | Firebase Auth（メール/パスワード） |
| NFR-021 | 通信暗号化 | HTTPS必須 |
| NFR-022 | ツール公開制限 | 内部ツール（FTP, ZIP, 変換, embedding, DB操作）は非公開 |

### 3.3 拡張性

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-030 | RAG差し替え可能性 | Firestore / Dify / LangGraph / Elastic等を差し替え可能 |
| NFR-031 | エージェント基盤選択 | Dify / LangGraph / ADK から選択可能 |

### 3.4 保守性

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-040 | コード品質 | Ruff（Lint/Format）、pytest（テスト） |
| NFR-041 | デプロイ | GitHub push による自動デプロイ |

---

## 4. 制約条件

### 4.1 技術的制約

| ID | 制約 | 詳細 |
|----|------|------|
| TC-001 | フロントエンド | Next.js 16, React 19, TypeScript 5, Tailwind 4 |
| TC-002 | バックエンド | Python 3.12+, FastAPI, uv |
| TC-003 | インフラ | Firebase App Hosting, Cloud Run, Firestore |
| TC-004 | LLM | Google ADK / Gemini, Vertex AI（本番） |

### 4.2 ビジネス制約

| ID | 制約 | 詳細 |
|----|------|------|
| BC-001 | 対象文書 | 3GPP標準化寄書のみ |
| BC-002 | 言語 | 文書は英語、UI/ドキュメントは日本語 |

---

## 5. 設計原則

本プロジェクトでは以下の5つの設計原則を遵守する。

| # | 原則 | 説明 |
|---|------|------|
| 1 | **正規化優先** | docx正規化で下流処理を統一 |
| 2 | **Evidence入力固定** | 分析エージェントはRAG実装を知らない |
| 3 | **RAG差し替え前提** | RAGは裏方、ロックインしない設計 |
| 4 | **ツール非公開** | 危険なツール（FTP, 変換等）は外に出さない |
| 5 | **引用トレーサビリティ** | 全分析結果に根拠を付与 |

> 「寄書分析の価値」はRAGではなく、正規化・構造化・分析ロジックにある。
> RAGは取り換え可能な設計にするのが正解。

---

## 6. ロードマップ

### 6.1 フェーズ概要

```
Phase 1: 基盤構築
    ↓
Phase 2: 分析機能（個別関数）
    ↓
Phase 3: 会話エージェント（Phase 2をツール化）
```

### 6.2 Phase 1: 基盤構築 ✅ 実装完了

RAG抽象化までを構築。これだけでも「文書の検索・閲覧」として価値がある。

| ID | 機能 | 詳細 | 状態 |
|----|------|------|------|
| P1-01 | FTP同期 | メタデータ先行同期、遅延ダウンロード、自動ダウンロード | ✅ 完了 |
| P1-02 | ファイル正規化 | doc→docx変換、ZIP展開対応 | ✅ 完了 |
| P1-03 | 構造抽出・チャンク化 | 見出しベース分割、メタデータ付与 | ✅ 完了 |
| P1-04 | ベクトル化 | Vertex AI text-embedding-004、Firestoreベクトル検索 | ✅ 完了 |
| P1-05 | Evidence取得IF | RAG抽象化境界、FirestoreProvider実装 | ✅ 完了 |
| P1-06 | 文書管理UI | 一覧表示、ステータス可視化、処理トリガー、署名URL経由ダウンロード | ✅ 完了 |

#### Phase 1 実装詳細

**P1-01 FTP同期**
- 3GPP FTPサーバーからのメタデータ同期
- 会合単位での寄書一覧取得
- 処理開始時の自動ダウンロード（`gcs_original_path`が未設定の場合）

**P1-02 ファイル正規化**
- `.doc` → `.docx` 変換（LibreOffice headless）
- ZIP展開: `.docx`/`.doc`ファイルの自動抽出（`__MACOSX`等を除外）
- 正規化済みファイルはGCS `normalized/`に保存

**P1-03 構造抽出・チャンク化**
- Word見出しスタイル（Heading 1-6）に基づく分割
- 1チャンク最大1000トークン
- メタデータ付与: 寄書番号、会合、条項番号、ページ番号

**P1-04 ベクトル化**
- Vertex AI `text-embedding-004`モデル（768次元）
- バッチ処理（100チャンク単位）
- Firestore `chunks`コレクションに保存

**P1-05 Evidence取得IF**
- `EvidenceProvider`抽象インターフェース
- `FirestoreProvider`: Firestore Vector Search実装
- コサイン類似度による検索

**P1-06 文書管理UI**
- 会合選択、寄書一覧表示
- ステータス可視化（metadata_only → indexed）
- SSEによるリアルタイム進捗表示
- 署名URL経由でのオリジナル/正規化ファイルダウンロード

### 6.3 Phase 2: 分析機能 ✅ 実装完了

個別の分析関数として実装。結果は永続化して再利用可能に。

| ID | 機能 | 詳細 | 状態 |
|----|------|------|------|
| P2-01 | `analyze_single()` | 単体寄書の分析（要点、変更点、論点） | ✅ 完了 |
| P2-02 | `compare_docs()` | 複数寄書の比較分析 | 未着手 |
| P2-03 | `generate_review_sheet()` | レビューシート生成 | ✅ 完了 |
| P2-04 | 分析結果の永続化 | Firestoreに保存、再分析コスト削減 | ✅ 完了 |
| P2-05 | 分析UI | 分析実行、結果表示、ダウンロード | ✅ 完了 |
| P2-06 | 言語選択 | 出力言語の選択（日本語/英語） | ✅ 完了 |
| P2-07 | カスタム分析 | ユーザー定義プロンプトによる柔軟な分析 | ✅ 完了 |
| P2-08 | プロンプト保存 | カスタム分析用プロンプトのCRUD | ✅ 完了 |

#### Phase 2 実装詳細

**P2-01 単体分析**
- LLM（Gemini）による寄書の自動分析
- 要点サマリー、変更提案、論点の抽出
- RAGベースの根拠付与

**P2-03 レビューシート生成**
- Markdown形式でのレビューシート出力
- 署名URL経由でのダウンロード

**P2-06 言語選択**
- 日本語（ja）・英語（en）の選択
- サマリー、変更点説明、論点説明が選択言語で出力
- Evidence（根拠引用）は原文維持（翻訳なし）
- 技術用語（3GPP用語、条項番号等）は英語維持

**P2-07 カスタム分析**
- ユーザーが自由にプロンプトを入力して分析を実行
- 例: 「セキュリティの観点でサマライズして」
- 例: 「XXに関する記述は含まれていますか？」
- 分析結果は回答（answer）と根拠（evidences）で構成

**P2-08 プロンプト保存**
- よく使うプロンプトを名前付きで保存
- ユーザーごとに管理（user_id紐付け）
- 保存済みプロンプトの選択・編集・削除

**利用イメージ:**
- 会合前に担当寄書をレビュー
- 競合提案の比較表を自動生成
- レビューシートをチームに共有
- 特定の観点（セキュリティ、性能等）での分析
- 特定トピックの有無確認

### 6.4 Phase 3: 会話エージェント

Phase 2 の関数をツールとして統合した汎用エージェント。

| ID | 機能 | 詳細 | 状態 |
|----|------|------|------|
| P3-01 | 会話エージェント | Phase 2機能をツールとして呼び出し | 未着手 |
| P3-02 | `summarize_meeting()` | 会合全寄書のサマライズ（個別＋全体レポート） | ✅ 完了 |
| P3-03 | `classify_by_topic()` | トピック別自動分類 | 未着手 |
| P3-04 | `detect_conflicts()` | 競合・対立の検出 | 未着手 |
| P3-05 | Q&A | RAGを利用した自由な質問応答 | ✅ 完了 |
| P3-06 | 会合レポート生成 | 全体俯瞰、注目寄書、論点整理 | ✅ 完了 |

#### Phase 3 実装詳細

**P3-02 会合サマライズ**
- 会合内のすべてのINDEXED寄書を取得
- 各寄書を軽量モデル（gemini-2.0-flash）で個別サマライズ
- 個別サマリーを高性能モデル（gemini-2.5-pro）で統合し全体レポート生成
- カスタムプロンプト対応（例：「セキュリティ観点で」）
- 結果のキャッシュと再利用

**P3-05 Q&A**
- 3つのスコープ対応：単一寄書、会合内、全体横断
- RAGベースのセマンティック検索（EvidenceProvider経由）
- 根拠付き回答（寄書番号、条項番号の引用）
- メタデータフィルタとの組み合わせ

**P3-06 会合レポート生成**
- P3-02のsummarize_meeting()を内部で呼び出し
- MeetingReportAgentがRAG検索で詳細分析
- Markdownレポート生成（概要、主要論点、注目寄書、参考資料）
- GCS保存＋署名URLでダウンロード提供

**利用イメージ:**
- 「SA1#112で議論が紛糾しそうなトピックは？」
- 「この要件に反対している会社はある？」
- 「過去3回の会合での議論経緯を教えて」

### 6.5 Phase 2 → Phase 3 の関係

```python
# Phase 2: 個別関数として実装
async def analyze_single(doc_id: str) -> AnalysisResult:
    ...

# Phase 3: エージェントのツールとしてラップ
@tool
async def analyze_single_tool(doc_id: str) -> str:
    """寄書を分析し、要点・変更点・論点を抽出する"""
    result = await analyze_single(doc_id)  # Phase 2を再利用
    return result.to_markdown()

# Phase 3: 複合的な処理
async def summarize_meeting(meeting: str):
    docs = await list_contributions(meeting)
    # 分析済みは永続化済み結果を使用、未分析のみ実行
    summaries = await asyncio.gather(*[
        get_or_analyze(doc) for doc in docs
    ])
    return await generate_meeting_report(summaries)
```
